{% extends "base.html" %}

{% block title %}Payment Pending - NestGold{% endblock %}

{% block content %}
<div class="container my-5 text-center">
    <h2>Payment Prompt Sent!</h2>
    <p class="lead">Check your phone for the M-Pesa STK push from {{ checkout_id }}.</p>
    <div class="spinner-border text-warning my-5" role="status" style="width: 4rem; height: 4rem;">
        <span class="visually-hidden">Waiting...</span>
    </div>
    <p>Complete the payment on your phone. This page will update automatically when confirmed.</p>

    <script>
        const checkoutId = "{{ checkout_id }}";
        const successUrl = "{{ url_for('subscription.success') }}";
        const failedUrl = "{{ url_for('subscription.failed') }}";
        const pollTimeoutMs = 180000; // 3 minutes
        const startedAt = Date.now();

        const interval = setInterval(() => {
            fetch(`/subscribe/check/${checkoutId}`)
                .then(r => r.json())
                .then(data => {
                    console.log('Poll status:', data.status);
                    if (data.status === 'completed') {
                        window.location.href = successUrl;
                        clearInterval(interval);
                    } else if (data.status === 'failed') {
                        window.location.href = failedUrl;
                        clearInterval(interval);
                    } else if (data.status === 'not_found') {
                        clearInterval(interval);
                        alert('We could not find this payment request. Please try again.');
                    } else if (Date.now() - startedAt > pollTimeoutMs) {
                        clearInterval(interval);
                        alert('Payment confirmation is taking longer than expected. Please refresh or check again shortly.');
                    }
                })
                .catch(err => console.error('Polling error:', err));
        }, 5000);  // every 5 seconds
    </script>
</div>
{% endblock %}
